<!DOCTYPE html>
<html>
	<head>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		@@include('url-config.html')
	</head>
	<style>


	.border-info{

		border: 1px solid #e1e4e3;
	}

	.left-move{
		position: absolute;top:50%;left:-5px;margin-top: -15px;
	}

	.left-move>i{

		font-size: 45px;
		 color: #1E9FFF;

	}
	.left-move>i:hover{

		color: #5FB878;
	}

  .layui-this .dd-handle{

    background-color: #0085E8;
  }
	</style>
	<body class="bg-info">

		<div class="layui-card  border-info">

			<div class="layui-card-header layui-card-header-bb-2" style="height: 70px;line-height: 20px; padding-left: 0;padding-right: 8px;">
				<div style="float: left;line-height: 70px; padding-left: 20px;font-size: 15px;font-weight: bold;">

					标准参数
				</div>

				<div style="border-left: 2px solid #e1e4e3;float: right;margin: 5px;">

					<div class="card-btn" style="margin-left: 10px;" onclick="save()">
						<div class="card-btn-img img-save"></div>
						<div class="card-btn-desc">
							保存
						</div>
					</div>

				</div>


			</div>
			<div class="layui-card-body">

				<div class="layui-row">

					<div class="layui-col-sm3 " style="padding-right: 10px;">

						<div class="layui-card border-info" >

							<div class="layui-card-header " style="font-weight: bold;">

								标准参数
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable">

								</div>

							</div>

						</div>
					</div>
					<div class="layui-col-sm3 " style=" padding-right: 10px;">
						<div class="layui-card border-info" >

							<div class="layui-card-header" style="font-weight: bold;">

								模板元素
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable1">
									</div>

							</div>

						</div>
					</div>

					<div class="layui-col-sm6 " style="padding-left: 40px;position: relative;">
						<div class="left-move">

							<i class="layui-icon layui-icon-next" ></i>
						</div>
						<div class="layui-card border-info" >

							<div class="layui-card-header" style="font-weight: bold;">

								映射关系
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable2">
								</div>

							</div>

						</div>

					</div>
				</div>


			</div>

		</div>

		<input type="hidden" name ="chnlType" />
		<input type="hidden" name ="chnlTypeName" />
	</body>

	<script>




		$(".dd").height($(window).height()-200);

    $(function(){
      init();
    });

		function init(){


		var url = ctx+"/cfgmgr/cfg/cfgParamMaps/updateInit";

		var param = util.getUrlParam();

		$("input[name=chnlType]").val(param.chnlType);

		$("input[name=chnlTypeName]").val(param.chnlTypeName);

		util.ajaxJson("页面加载中，请稍后...",url,{"chnlType":param.chnlType,"frontBack":param.frontBack},function(data){

			if(data.result != "0"){

				util.showDialog("页面加载失败!",0);

				console.log(data);

				return ;
			}
			var cfgMergeParamList = data.body.cfgMergeParamList;


		  var modelmentList=modelmentList=data.body.modelmentList;
		  if(param.frontBack=='0'){
		      modelmentList=data.body.appModelmentList;
		  }
		  var cfgParamMapList=data.body.cfgParamMapList;
		  //初始化第一列
		  initPage('#nestable',cfgMergeParamList,"paramName","paramNameCn");
		  //初始化第二列
		  initPage('#nestable1',modelmentList,"modelementCode","modelementName");
		  //初始化第三列
		  //initPage('#nestable2',cfgParamMapList,"paramKey","paramDesc");
      initThree('#nestable2',cfgParamMapList,"paramKey","paramDesc","modelKey","modelName");
		});

		//第一步
		//initPage('#nestable',data,key,keyName);

		// 第二部
		// initPage('#nestable1',data,key,keyName);

		//绑定事件
		buildEvent();
		}


		function save(){

			var ret = [];

			$.each($("#nestable2 li "),function(i,item){

				var r = {};

				//r.standardKey = $(item).data("json");

				//r.modelKey = $(item).data("json1");

        r.chnlType=$("input[name=chnlType]").val()
        r.chnlTypeName=$("input[name=chnlTypeName]").val();
        r.paramKey= $(item).data("json")['paramName'];
        r.paramDesc=$(item).data("json")['paramNameCn'];
        r.frontBack=$(item).data("json")['fbFlag'];
        r.frontBackName=$(item).data("json")['fbFlagDesc'];
        r.modelKey=$(item).data("json1")['modelementCode'];
        r.modelName=$(item).data("json1")['modelementName'];


				ret.push(r);
			});

			console.log(ret);

      var url = ctx+"/cfgmgr/cfg/cfgParamMaps/saveUpdate";
      util.ajaxJson("保存中，请稍后···",url,{"chnlType":$("input[name=chnlType]").val(),"cfgParamMapList":ret},function(data){


      	console.log(data);

      	if(data.result != "0"){

      		util.error("保存失败!");

      	}else{

      		util.success("保存成功!");
      	}
        });

		}

		function buildEvent(){

			$("#nestable,#nestable1").delegate('li','click',function(){

				$(this).parents("ol").find("li").removeClass("layui-this");

				$(this).addClass('layui-this');

			});


			$(".left-move i").click(function(){


				var onethis = $("#nestable li.layui-this ");

				var twothis = $("#nestable1 li.layui-this ");

				if(onethis.length == 0){

					util.showDialog("请选择标准参数！",0);

					return ;
				}

				if(twothis.length == 0){

					util.showDialog("请选择模板参数！",0);

					return ;
				}

				onethis.attr("data-json1",JSON.stringify(twothis.data("json")));

				var html1 = onethis.find(".dd-handle").html();

				var html2 = twothis.find(".dd-handle").html();

				var closeBtn = '<i class="layui-icon layui-icon-delete " style="font-size: 30px; color:red ;float:right;margin-top:-35px;"></i> ';

				onethis.find(".dd-handle").html('<span>'+html1+"||"+html2+'</span>'+closeBtn);

				if($("#nestable2>ol").length == 0){

					$("#nestable2").append($('<ol class="dd-list"></ol>'));
				}
				$("#nestable2 ol ").append(onethis);
			});

			$("#nestable2").delegate('.layui-icon-delete','click',function(){

				var parentLi = $(this).parent().parent("li");

					var clone1 = parentLi.clone();

					var clone2 = parentLi.clone();

					clone1.data("json1",null);

					var span = clone1.find("span");

					var spanArr = span.html().split("||");

					clone2.data("json",clone2.data("json1"));

					clone2.data("json1",null);

					clone1.find(".dd-handle").html(spanArr[0]);

					clone2.find(".dd-handle").html(spanArr[1]);

					parentLi.remove();
			});
		}


		function initThree(id,data,key,keyName,key1,keyName1){


			var ol = $('<ol class="dd-list"></ol>');

			$.each(data,function(i,item){

				var li = $('<li class="dd-item" ></div>');

				var json = {};
				json[key] = item[key];
				json[keyName] = item[keyName];

				$("#nestable li[ag-key="+key+"]").remove();

				$("#nestable1 li[ag-key="+key1+"]").remove();

				var json1 = {};
				json1[key1] = item[key1];
				json1[keyName1] = item[keyName1];

				li.attr("data-json",JSON.stringify(json));

				li.attr("data-json1",JSON.stringify(json1));

				var closeBtn = '<i class="layui-icon layui-icon-delete " style="font-size: 30px; color:red ;float:right;margin-top:-35px;"></i> ';

				var div = $('<div class="dd-handle"><span>'+item[key]+"-"+item[keyName]+"||"+item[key1]+"-"+item[keyName1]+'</span> '+closeBtn+'</div>');

				li.append(div);

				ol.append(li);

			});

			$(id).append(ol);

		}


		function  initPage(id,data,key,keyName){

			var ol = $('<ol class="dd-list"></ol>');

			$.each(data,function(i,item){

				var li = $('<li class="dd-item" ></div>');

				li.attr("data-json",JSON.stringify(item));
				li.attr('ag-key',item[key]);

				var div = $('<div class="dd-handle">'+item[key]+"-"+item[keyName]+'</div>');

				li.append(div);

				ol.append(li);

			});

			$(id).append(ol);
		}


	</script>
</html>

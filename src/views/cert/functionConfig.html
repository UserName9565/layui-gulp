<!DOCTYPE html>
<html>
	<head>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		@@include('url-config.html')
		<script  src="/static/js/plugins/nestable/jquery.nestable.js"></script>
	</head>
	<style>


	.border-info{

		border: 1px solid #e1e4e3;
	}

	</style>
	<body class="bg-info">

		<div class="layui-card  border-info">

			<div class="layui-card-header layui-card-header-bb-2" style="height: 70px;line-height: 20px; padding-left: 0;padding-right: 8px;">
				<div style="float: left;line-height: 70px; padding-left: 20px;font-size: 15px;font-weight: bold;">

					采集功能配置
				</div>

				<div style="border-left: 2px solid #e1e4e3;float: right;margin: 5px;">

					<div class="card-btn" style="margin-left: 10px;" onclick="save()">
						<div class="card-btn-img img-save"></div>
						<div class="card-btn-desc">
							保存
						</div>
					</div>

				</div>


			</div>
			<div class="layui-card-body">

				<div class="layui-row">

					<div class="layui-col-sm4 " style="padding-right: 15px;">

						<div class="layui-card border-info" >

							<div class="layui-card-header " style="font-weight: bold;">

								可选功能
								<!-- <div style="float: right;">
									<i class="layui-icon layui-icon-addition" style="font-size: 30px; color: #1E9FFF;"></i>
								</div> -->
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable">

									</div>

							</div>

						</div>
					</div>
					<div class="layui-col-sm4 " style="">
						<div class="layui-card border-info" >

							<div class="layui-card-header" style="font-weight: bold;">

								外部接入
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable1">
									</div>

							</div>

						</div>
					</div>
					<div class="layui-col-sm4 " style="padding-left: 15px;" id="certCollectDiv">
						<div class="layui-card border-info" >

							<div class="layui-card-header" style="font-weight: bold;">

								内部接入
							</div>
							<div class="layui-card-body" style="padding: 10px;">

								<div class="dd" id="nestable2">
								</div>

							</div>

						</div>

					</div>
				</div>


			</div>

		</div>

		<input type="hidden" name ="chnlType" />
		<input type="hidden" name ="chnlTypeName" />
    <input type="hidden" name ="cfgType" />
    <input type="hidden" name ="cfgTypeName" />
	</body>

	<script>


		$(function(){

			var url = ctx+"/cfgmgr/cfg/settings/chnlpicfuncs/updateInit";

			var param = util.getUrlParam();

			$("input[name=chnlType]").val(param.chnlType);
			$("input[name=chnlTypeName]").val(param.chnlTypeName);
      $("input[name=cfgType]").val(param.cfgType);
      $("input[name=cfgTypeName]").val(param.cfgTypeName);

      if(param.cfgType==1){
        $('#certCollectDiv').hide();
        $('.layui-col-sm4').removeAttr("class","layui-col-sm4").addClass("layui-col-sm6");
      }

			util.ajaxJson("页面加载中，请稍后...",url,{"chnlType":param.chnlType,"cfgType":param.cfgType},function(data){

				if(data.result != "0"){

					util.showDialog("页面加载失败!",0);

					console.log(data);

					return ;
				}

				var cfgPicFuncList = data.body.cfgPicFuncList;
				var cfgChnlPicFuncNList = data.body.cfgChnlPicFuncNList;
				var cfgChnlPicFuncYList = data.body.cfgChnlPicFuncYList;

				$('#nestable').nestable({
					group: 1,
					maxDepth:1,
					rmSourceItem:false,
					itemKey:"funcCode",
					itemName:'funcName',
					data:cfgPicFuncList
				});

				$('#nestable1').nestable({
					group: 1,
					maxDepth:1,
					dragFlag:false,//是否允许拖拽
					addItemCloseBtn:true,//是否添加删除按钮
					addItemQuickBtn:true,//是否添加快捷方式选择
					itemKey:"funcCode",
					itemName:'funcName',
					quickKey:'quickFlag',//快捷方式 对应 bean的属性名
					data:cfgChnlPicFuncYList
				});

				$('#nestable2').nestable({
					group: 1,
					maxDepth:1,
					dragFlag:false,
					addItemCloseBtn:true,
					addItemQuickBtn:true,
					itemKey:"funcCode",
					itemName:'funcName',
					quickKey:'quickFlag',
					data:cfgChnlPicFuncNList
				});
			});

		});


		function save(){

			var arr  = $('#nestable1').nestable('getItemData');
			var arr1  = $('#nestable2').nestable('getItemData');

			for(var i = 0 ; i < arr.length ; i++){
				arr[i].chnlType = $("input[name=chnlType]").val();
				arr[i].chnlTypeName = $("input[name=chnlTypeName]").val();
        arr[i].cfgType = $("input[name=cfgType]").val();
        arr[i].cfgTypeName = $("input[name=cfgTypeName]").val();
				arr[i].outFlag="0";
				arr[i].outFlagName="外部接入";
			}

			for(var i = 0 ; i < arr1.length ; i++){
				arr1[i].chnlType = $("input[name=chnlType]").val();
				arr1[i].chnlTypeName = $("input[name=chnlTypeName]").val();
        arr1[i].cfgType = $("input[name=cfgType]").val();
        arr1[i].cfgTypeName = $("input[name=cfgTypeName]").val();
				arr1[i].outFlag="1";
				arr1[i].outFlagName="内部接入";
			}
      var array=arr;
      if($("input[name=cfgType]").val()==0){
         array = arr.concat(arr1);
      }
			var url = ctx+"/cfgmgr/cfg/settings/chnlpicfuncs/update";

			util.ajaxJson("保存中，请稍后···",url,{"chnlType":$("input[name=chnlType]").val(),"cfgType":$("input[name=cfgType]").val(),"cfgChnlPicFuncNList":array},function(data){


				console.log(data);

				if(data.result != "0"){

					util.error("保存失败!");

				}else{

					util.success("保存成功!");
					
					parent.refreshSts(array.length > 0 ? true :false );
				}
			});
		}



		$(".dd").height($(window).height()-200);



	</script>
</html>

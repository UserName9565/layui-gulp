<!DOCTYPE html>
<html>
	<head>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		@@include('url-config.html')
		<link rel="stylesheet" href="/static/css/plugins/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css"/>
		<script type="text/javascript" src="/static/js/plugins/ztree/js/jquery.ztree.all.min.js" ></script>
		<script type="text/javascript" src="/static/js/plugins/ztree/js/jquery.ztree.exhide-3.5.js" ></script>
	</head>
	<style>

	.page-left {
		
		position: absolute;
		left: 20px;
		top: 20px;
		width: 300px;
		bottom: 20px;
		
	}
	.page-right{
		
		position: absolute;
		top: 20px;
		left: 340px;
		right: 2px;
		bottom: 20px;
		width: calc( 100vw - 360px);
		height: calc( 100vh - 40px);
	}
	
	
	

	</style>
	<body class="bg-info">
		
		<div class="page-left">
			
			<div class="layui-card  border-info">
				
				<div class="layui-card-header   layui-card-header-bb-2" style="height: 55px;line-height: 20px; padding-left: 0;padding-right: 8px;padding-top: 15px;">
						<div class="layui-input-inline" style="padding-left: 30px;">
						  <input class="layui-input  " id="searchInput" value="" placeholder="输入查询节点内容...">
						</div>
						<div class="layui-input-inline">
						  <button class="layui-btn layui-btn-normal" id="search_btn" onclick="showcheck()">查询</button>
						</div>  
							  
							  
				</div>
				
				<div class="layui-card-body" >
			
					<div class="layui-row" >
						
						<ul id="tree"class="ztree"  style="height: calc( 100vh - 140px);"></ul>
			
					</div>
			
				</div>
			
			</div>
			
		</div>
		
		<div class="page-right">
			
			<div class="layui-card layui-card-form" style="margin: 0;padding: 0;">
				
			  <div class="layui-card-header layui-card-header-bb-2" style="height: 70px;line-height: 20px; padding-left: 0;padding-right: 8px;">
			  	<div style="float: left;line-height: 70px; padding-left: 20px;font-size: 15px;font-weight: bold;">
			  
			  		菜单信息设置
			  	</div>
			  
			  	<div style="border-left: 2px solid #e1e4e3;float: right;margin: 5px;">
			  
			  		<div class="card-btn ag-btn-save" style="margin-left: 10px;" ag-back-func="refreshNode"  ag-data-url="/sys/func/updateCFunc" ag-data-index="1" >
			  			<div class="card-btn-img img-save"></div>
			  			<div class="card-btn-desc">
			  				保存
			  			</div>
			  		</div>
			  
			  	</div>
			  
			  
			  </div>
			
			  <div class="layui-card-body" style="height: calc( 100vh - 130px);">
			
			    <form class="ag-form layui-form layui-hide " ag-data-index="1"  style="padding-top: 10px;">
			
			      <div class="layui-inline ">
					  
					  <input type="hidden" name="tId"  value="" />
			
			        <div class="layui-inline ">
			          <label class="layui-form-label">菜单编码：</label>
			          <div class="layui-input-block">
			            <input type="text" name="functionCode" ag-verify="required" readonly="readonly" autocomplete="off" placeholder="菜单编码" class="layui-input ">
			          </div>
			        </div>
			
			        <div class="layui-inline ">
			          <label class="layui-form-label">菜单名称：</label>
			          <div class="layui-input-block">
			            <input type="text" name="functionName" ag-verify="required" autocomplete="off" placeholder="菜单名称" class="layui-input">
			          </div>
			        </div>
			
			        <div class="layui-inline ">
			          <label class="layui-form-label">父级编码：</label>
			         <div class="layui-input-block">
			           <input type="text" name="parentCode" readonly="readonly" ag-verify="required" autocomplete="off" placeholder="父级编码" class="layui-input ">
			         </div>
			        </div>
					<div class="layui-inline ">
					  <label class="layui-form-label">父级名称：</label>
					  <div class="layui-input-block">
					    <input type="text" name="parentName" readonly="readonly"  ag-verify="required" autocomplete="off" placeholder="父级名称" class="layui-input ">
					  </div>
					</div>
			
			        <div class="layui-inline ">
			          <label class="layui-form-label">状态：</label>
			          <div class="layui-input-block">
			            <select name="validFlag" ag-sel-name="validFlagName">
							<option value="N">否</option>
							<option value="Y">是</option>
			            </select>
			          </div>
			        </div>
			
			        <div class="layui-inline ">
			          <label class="layui-form-label">请求地址：</label>
			          <div class="layui-input-block">
			            <input type="text" name="jspUrl" ag-verify="required" autocomplete="off" placeholder="请求地址" class="layui-input">
			          </div>
			        </div>
			       
					
			
			    </form>
			
			
			  </div>
			
			
			</div>
			
		</div>

		
	</body>

	<script>

	$(function(){
		
		
		
		})
	  var zTreeObj,
		 setting = {
				view: {
					addHoverDom: addHoverDom,
					removeHoverDom: removeHoverDom,
					selectedMulti: false
				},
				edit: {
					enable: true,
					editNameSelectAll: true,
					showRemoveBtn: showRemoveBtn,
					showRenameBtn: showRenameBtn
				},
				data: {
				key:{
				name:"functionName"
					},
					simpleData: {
						enable:true,
						idKey: "functionCode",
						pIdKey: "parentCode",
						rootPId: ""
					}
				},
				callback: {
					beforeDrag: beforeDrag,
					beforeEditName: beforeEditName,
					beforeRemove: beforeRemove,
					beforeRename: beforeRename,
					onRemove: onRemove,
					onRename: onRename,
					beforeClick:beforeClick
				}
			};
			
			function beforeClick(treeId, treeNode){
				
				if(treeNode.children){
					
					 zTreeObj.showNodes(treeNode.children);
				}
			}
			
			
			var  className = "dark";
			//拖拽前设置
			function beforeDrag(treeId, treeNodes) {
				return false;
			}
			//修改名称前
			function beforeEditName(treeId, treeNode) {
				className = (className === "dark" ? "":"dark");
				zTreeObj.selectNode(treeNode);
				var flag =confirm("确定修改菜单【 -- " + treeNode.functionName + "】吗？");
				
				if(flag){
					updateFunc(treeNode);
				}
				return false;
			}
			function updateFunc(treeNode){
				
				var parNode =zTreeObj.getNodeByTId(treeNode.parentTId);
				
				console.log(treeNode);
				
				refreashForm(parNode,treeNode);
				
				showForm();
				
			}
			
			function refreshNode(data){
				
				var tId = $(".ag-form [name=tId]").val();
				
				var node  = zTreeObj.getNodeByTId(tId);
				
				$.extend(node,data.body);
				
				 zTreeObj.updateNode(node);
				 zTreeObj.refresh();
				updateFunc(node);
			}
			
			function refreashForm(parNode,treeNode){
				
				$.each($(".ag-form [name]"), function(i,item){
					
					$(item).val(treeNode[$(item).attr("name")]);
				});
				
				$(".ag-form [name=parentCode]").val(parNode.functionCode);
				
				$(".ag-form [name=parentName]").val(parNode.functionName);
				
				
				layui.checkForm.render();
			}
			
			function resetForm(){
				
				$(".ag-form [name]").val("");
				
				$(".ag-form").addClass("layui-hide");
			}
			
			function showForm(){
				
				$(".ag-form").removeClass("layui-hide");
				
			}
			
			//删除前
			function beforeRemove(treeId, treeNode) {
				className = (className === "dark" ? "":"dark");
				zTreeObj.selectNode(treeNode);
				return confirm("确认删除 菜单【 " + treeNode.functionName + "】吗？");
			}
			
			//删除操作之后回调
			function onRemove(e, treeId, treeNode) {
				
				if(treeNode.functionCode==undefined || treeNode.functionCode.startsWith("new")){
					
					return false;
				}
				
				resetForm();
				
				var url = ctx+"/sysmgr/sys/func/del";
				
				util.ajaxJson("删除中，请稍后...",url,{"functionCode":treeNode.functionCode},function(data){
				
					if(data.result != "0"){
				
						util.showDialog("删除失败!",0);
						
						var parNode =zTreeObj.getNodeByTId(treeNode.parentTId);
						
						zTreeObj.addNodes(parNode,treeNode);
				
						return ;
					}
					util.showDialog("删除成功!",1);
					
				});
				
				
			}
			
			//更新节点名称前
			function beforeRename(treeId, treeNode, newName, isCancel) {
				className = (className === "dark" ? "":"dark");
				if (newName.length == 0) {
					util.showDialog("节点名称不能为空.",0);
					setTimeout(function(){zTreeObj.editName(treeNode)}, 10);
					return false;
				}
				return true;
			}
			//更新名称后
			function onRename(e, treeId, treeNode, isCancel) {
			}
			//是否展现删除按钮
			function showRemoveBtn(treeId, treeNode) {
				return !treeNode.isParent;
			}
			//是否展现修改名称按钮
			function showRenameBtn(treeId, treeNode) {
				return true;
			}
			//鼠标移入操作
			function addHoverDom(treeId, treeNode) {
				var sObj = $("#" + treeNode.tId + "_span");
				if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
				var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
					+ "' title='add node' onfocus='this.blur();'></span>";
				sObj.after(addStr);
				var btn = $("#addBtn_"+treeNode.tId);
				if (btn) btn.bind("click", function(){
					
					if(treeNode.functionCode.startsWith("new")){
						
						util.showDialog("父菜单未保存!",0);
						
						return false;
					}
					
					zTreeObj.addNodes(treeNode, {id:"new"+new Date().getTime(), pId:treeNode.id, functionName:"新菜单" ,functionCode:"new"+new Date().getTime()});
					return false;
				});
			};
			//鼠标移出操作
			function removeHoverDom(treeId, treeNode) {
				$("#addBtn_"+treeNode.tId).unbind().remove();
			};
		$(document).ready(function(){
			
			var url = ctx+"/"+util.getAgCtx()+"/sys/func/queryList";
			
			util.ajaxJson("页面加载中，请稍后...",url,{},function(data){
				
				zTreeObj = $.fn.zTree.init($("#tree"), setting,data );
				
				var node  = zTreeObj.getNodeByTId("tree_1");
				
				zTreeObj.expandNode(node, true, false, false);
				
			});
			
		});
		//初始化节点树
		
		 function trimtest(str){
		         //   用正则表达式将前后空格
		         //   用空字符串替代。
		        return   str.replace(/(^\s*)|(\s*$)/g,"");
		}
		//将所有隐藏的节点显示出来。
	    function refreashNodes() {
	        nodes = zTreeObj.getNodesByParam("isHidden", true);
	        zTreeObj.showNodes(nodes);
	    }
	    function showcheck(){
					
			util.load('检索中请稍后!');
			
			showSelected();
			
			
			util.disLoad();
		}
	    function showSelected(){
	    	
	        var searchStr = $('#searchInput').val();//通过id获取页面输入的值
	        if (searchStr=='') {
	            refreashNodes();
	            return ;
	        }
			
	        var allNodes = zTreeObj.transformToArray(zTreeObj.getNodes());
	       
	        	zTreeObj.hideNodes(allNodes); //隐藏所有节点
	       // var nodes = zTreeObj.getNodesByFilter(filter); // 查找节点集合 两种方式
	       
	      	var nodes = zTreeObj.getNodesByParamFuzzy("functionName", searchStr);
	       
	        if(nodes.length == 0){
	            return ;
	        }
	    	
	        var resultNodes  = new Array();
	        $.each( nodes, function(i, n){
	            var tempNode = n;
	            for(var i=0;i< n.level;i++){
	                tempNode = tempNode.getParentNode();//获取当前被选中的节点的父节点
	                if(tempNode!=null&&tempNode!=""){
	                 resultNodes.push(tempNode);
	                }
	            }
	        });
	        resultNodes = resultNodes.concat(nodes);           //concat() 方法用于连接两个或多个数组。该方法不会改变现有的数组，而仅仅会返回被连接数组的一个副本。
	        zTreeObj.showNodes(resultNodes);
	        zTreeObj.expandAll(true);
	     
	    }
	    
	    function showValNode(obj){
	    	var val = $(obj).val();
	    	val =trimtest(val);
	    	if(val==""){
	    		refreashNodes();
	    	}
	    }
	


	</script>
</html>
